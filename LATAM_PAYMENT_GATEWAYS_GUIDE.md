# LATAM Payment Gateways Configuration Guide

## Deployed Payment Gateways ✅

### Universal LATAM Gateway (7 Countries)
#### MercadoPago
- **Countries**: Argentina, Brazil, Mexico, Chile, Colombia, Uruguay, Peru
- **Payment Methods**: Credit/debit cards, digital wallets, cash (country-specific)
- **Setup Cost**: FREE
- **Transaction Fees**: 3.5% - 5.9% (varies by country)

**Environment Variables:**
```bash
MERCADOPAGO_ACCESS_TOKEN=your_access_token_here
MERCADOPAGO_PUBLIC_KEY=your_public_key_here
MERCADOPAGO_TEST_MODE=true  # Set to false for production
MERCADOPAGO_WEBHOOK_URL=https://your-app.com/api/webhooks/mercadopago
```

**Country-Specific Payment Methods:**
- **Argentina**: Credit/debit cards, Rapipago, Pago Fácil
- **Brazil**: Credit/debit cards, PIX, Boleto Bancário
- **Mexico**: Credit/debit cards, OXXO, SPEI
- **Chile**: Credit/debit cards, Khipu
- **Peru**: Credit/debit cards, PagoEfectivo
- **Uruguay**: Credit/debit cards, Abitab, RedPagos
- **Colombia**: Credit/debit cards, PSE, Efecty

---

### Brazil-Specific Gateway
#### PIX (Instant Payment)
- **Market Share**: 70%+ of digital transactions
- **Processing Time**: Real-time (24/7)
- **Setup Cost**: FREE
- **Transaction Fees**: 0% - 1% (depends on provider)

**Environment Variables:**
```bash
PIX_KEY=your_pix_key_here  # Email, phone, CPF/CNPJ, or random key
PIX_API_KEY=your_api_key_here
PIX_TEST_MODE=true  # Set to false for production
```

**PIX Key Types:**
- Email: igreja@example.com
- Phone: +55 11 98765-4321
- CPF/CNPJ: 12.345.678/0001-90
- Random Key: Generated by Brazilian Central Bank

---

### Mexico-Specific Gateways
#### SPEI (Interbank Transfer)
- **Usage**: Bank-to-bank transfers
- **Processing Time**: Same day (up to 72 hours)
- **Setup Cost**: FREE
- **Transaction Fees**: 1.5% - 2.5%

#### OXXO (Cash Payment)
- **Network**: 20,000+ OXXO stores nationwide
- **Market Share**: 60% of cash payments
- **Processing Time**: Up to 72 hours
- **Setup Cost**: FREE
- **Transaction Fees**: 2% - 3%

**Environment Variables (Conekta):**
```bash
CONEKTA_MERCHANT_ID=your_merchant_id_here
CONEKTA_API_KEY=your_private_key_here
CONEKTA_TEST_MODE=true  # Set to false for production
```

---

## Colombia Gateways (Already Deployed) ✅

### PSE (Pagos Seguros en Línea)
```bash
PSE_MERCHANT_ID=your_merchant_id
PSE_API_KEY=your_api_key
PSE_TEST_MODE=true
```

### Nequi
```bash
NEQUI_CLIENT_ID=your_client_id
NEQUI_CLIENT_SECRET=your_client_secret
NEQUI_TEST_MODE=true
```

---

## Gateway Setup Instructions

### 1. MercadoPago Setup (Recommended First)
1. Go to https://www.mercadopago.com/developers
2. Create an account for your country
3. Navigate to "Your integrations" → "Create application"
4. Copy the Access Token and Public Key
5. Configure webhook URL in "Webhooks" section
6. Add environment variables to Railway/Vercel

**Webhook Events to Enable:**
- `payment` - Payment status updates
- `merchant_order` - Order status updates

### 2. Brazil PIX Setup
1. Register with a PIX provider (PagSeguro, Cielo, Mercado Pago)
2. Generate a PIX key (email, phone, or random)
3. Get API credentials from provider
4. Configure webhook for payment confirmations
5. Add environment variables

### 3. Mexico Conekta Setup (SPEI + OXXO)
1. Go to https://www.conekta.com
2. Create a merchant account
3. Complete KYC verification
4. Get API keys from dashboard
5. Enable SPEI and OXXO payment methods
6. Configure webhook endpoint
7. Add environment variables

---

## Testing Credentials

### MercadoPago Test Cards
```
Card Number: 5031 7557 3453 0604
CVV: 123
Expiration: 11/25
Name: APRO (approved) / CONT (contingency) / CALL (rejected)
```

### PIX Test Environment
```
Use sandbox.api.pix.bcb.gov.br for testing
Generate test QR codes
Payments auto-complete in test mode
```

### Conekta Test Cards
```
Card Number: 4242 4242 4242 4242
CVV: 123
Expiration: 12/25
```

**OXXO Test Reference:**
- In test mode, reference numbers are auto-validated after 5 minutes

**SPEI Test CLABE:**
- Test CLABE numbers are provided in sandbox environment

---

## Database Configuration

All gateways use the existing `payment_gateway_configs` table:

```sql
-- Example: Enable MercadoPago for a church
INSERT INTO payment_gateway_configs (
  id,
  church_id,
  gateway_type,
  is_enabled,
  is_test_mode,
  merchant_id,
  api_key,
  configuration
) VALUES (
  'cuid_generated_id',
  'church_id_here',
  'mercadopago',
  true,
  false,
  'merchant_id',
  'encrypted_api_key',
  '{"country": "MX", "allowed_methods": ["credit_card", "oxxo", "spei"]}'
);
```

---

## Webhook URLs (Railway Deployment)

Configure these URLs in each gateway's dashboard:

```
MercadoPago: https://your-app.railway.app/api/webhooks/mercadopago
PIX:         https://your-app.railway.app/api/webhooks/pix
Conekta:     https://your-app.railway.app/api/webhooks/conekta
Stripe:      https://your-app.railway.app/api/webhooks/stripe
```

**Security Headers Required:**
- MercadoPago: `x-signature`, `x-request-id`
- PIX: `Authorization: Bearer {token}`
- Conekta: `x-conekta-signature`

---

## Production Checklist

Before enabling gateways in production:

### MercadoPago
- [ ] Switch to production credentials (`MERCADOPAGO_TEST_MODE=false`)
- [ ] Verify webhook URL is reachable
- [ ] Test payment flow in production mode
- [ ] Configure IPN notifications
- [ ] Enable payment methods for target country

### PIX
- [ ] Register PIX key with Brazilian Central Bank
- [ ] Complete financial institution integration
- [ ] Test QR code generation
- [ ] Verify webhook receives payment confirmations
- [ ] Set up static QR codes for printed materials

### Conekta (SPEI/OXXO)
- [ ] Complete KYC verification
- [ ] Activate production API keys
- [ ] Test SPEI transfers (72-hour wait)
- [ ] Test OXXO payment at physical store
- [ ] Verify webhook signature validation
- [ ] Configure payment expiration times

---

## Multi-Country Strategy

**Recommended Gateway Configuration by Country:**

| Country     | Primary Gateway | Secondary Gateway | Cash Option |
|-------------|----------------|-------------------|-------------|
| Colombia    | PSE            | Nequi             | Efecty      |
| Brazil      | PIX            | MercadoPago       | Boleto      |
| Mexico      | SPEI           | MercadoPago       | OXXO        |
| Argentina   | MercadoPago    | -                 | Rapipago    |
| Chile       | MercadoPago    | Webpay*           | -           |
| Peru        | MercadoPago    | Yape*             | PagoEfectivo|
| Uruguay     | MercadoPago    | -                 | Abitab      |

\* Phase 4 implementation planned

---

## Cost Analysis

**Monthly Transaction Estimates (1,000 churches):**

| Gateway      | Avg Fee | Monthly Volume | Cost     |
|--------------|---------|----------------|----------|
| MercadoPago  | 4.5%    | $500k USD      | $22.5k   |
| PIX          | 0.5%    | $200k USD      | $1k      |
| SPEI         | 2%      | $150k USD      | $3k      |
| OXXO         | 2.5%    | $100k USD      | $2.5k    |
| PSE          | 3%      | $300k USD      | $9k      |
| **TOTAL**    |         | **$1.25M USD** | **$38k** |

**Cost Optimization Strategy:**
- Use country-specific gateways when available (lower fees)
- MercadoPago as fallback for countries without local gateway
- Promote PIX in Brazil (lowest fees, highest adoption)

---

## Support & Documentation

**MercadoPago:**
- Docs: https://www.mercadopago.com/developers/en/docs
- Support: developers@mercadopago.com

**PIX:**
- Docs: https://www.bcb.gov.br/estabilidadefinanceira/pix
- Support: Via your financial institution

**Conekta:**
- Docs: https://developers.conekta.com
- Support: soporte@conekta.com

**Internal Documentation:**
- Gateway implementations: `/lib/payments/`
- Webhook handlers: `/app/api/webhooks/`
- Database schema: `prisma/schema.prisma`
