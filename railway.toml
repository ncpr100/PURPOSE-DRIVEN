# Railway Configuration for Khesed-Tek Church Management Platform
# EMERGENCY: Force Cloud Builder instead of Metal Builder to prevent hanging
[build]
# Force Nixpacks Cloud builder - NEVER use Metal builder
builder = "NIXPACKS"
buildCommand = "./scripts/railway-build-fix.sh"

# Aggressive build environment variables to prevent Metal builder hanging
[build.environment]
# Memory optimization
NODE_OPTIONS = "--max-old-space-size=8192 --max-semi-space-size=1024 --no-deprecation"
NIXPACKS_NO_MUSL = "1"
NIXPACKS_NODE_VERSION = "18"
NIXPACKS_BUILD_CMD = "./scripts/railway-build-fix.sh"
# Prevent npm hangs
NPM_CONFIG_AUDIT = "false"
NPM_CONFIG_FUND = "false"
NPM_CONFIG_PROGRESS = "false"
# Force fast CI environment
CI = "true"
NODE_ENV = "production"
NEXT_TELEMETRY_DISABLED = "1"
# Railway-specific optimizations
RAILWAY_BUILDER_TIMEOUT = "1200"
RAILWAY_BUILD_PRIORITY = "high"

# Build command with timeout protection
[build.watchPaths]
include = ["app/**", "components/**", "lib/**", "prisma/**", "public/**"]
ignore = ["node_modules/**", ".next/**", ".git/**"]

# Deployment settings
[deploy]
healthcheckPath = "/api/health"
healthcheckTimeout = 30
restartPolicyType = "ON_FAILURE"
restartPolicyMaxRetries = 3

# Service configuration to prevent hangs
[service]
# Force restart if build hangs for too long
startCommand = "npm run start"